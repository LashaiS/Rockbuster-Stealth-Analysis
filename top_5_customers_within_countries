EXPLAIN
WITH top_5_customers_within_countries AS
(SELECT customer.customer_id,
 customer.first_name,
 customer.last_name,
 ctry.country,
 city.city,
SUM (pay.amount) AS total_amount_paid
FROM customer
INNER JOIN payment AS pay ON customer.customer_id= pay.customer_id
INNER JOIN address AS add ON customer.address_id = add.address_id
INNER JOIN city AS city ON add.city_id = city.city_id
INNER JOIN country AS ctry ON city.country_id = ctry.country_id
WHERE
city.city IN('Aurora','Atlixco','Xintai','Adoni','Dhule (Dhulia','Kurashiki',
'Pingxiang','Sivas','Celaya','So Leopoldo')
AND ctry.country IN ('India','China','United States','Japan', 'Mexico','Brazil',
'Russian Federation','Philippines','Turkey', 'Indonesia')
GROUP BY customer.customer_id, customer.first_name,
customer.last_name,city.city,ctry.country
ORDER BY total_amount_paid DESC
LIMIT 5)
SELECT ctry1.country,
COUNT(DISTINCT cust.customer_id) AS all_customer_count,
COUNT(DISTINCT top5.customer_id) AS top_customer_count
FROM customer AS cust
INNER JOIN address AS add1 ON cust.address_id = add1.address_id
INNER JOIN city AS city1 ON add1.city_id = city1.city_id
INNER JOIN country AS ctry1 ON city1.country_id = ctry1.country_id
LEFT JOIN top_5_customers_within_countries AS top5 ON top5.country = ctry1.country
GROUP BY ctry1.country
ORDER BY top_customer_count DESC, all_customer_count DESC;
